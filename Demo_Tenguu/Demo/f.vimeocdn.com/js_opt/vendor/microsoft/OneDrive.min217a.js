var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);r.prototype=t.prototype,e.prototype=new r};!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.OneDrive=e()}}(function(){return function e(t,r,i){function n(s,a){if(!r[s]){if(!t[s]){var l="function"==typeof require&&require;if(!a&&l)return l(s,!0);if(o)return o(s,!0);throw new Error("Cannot find module '"+s+"'")}var c=r[s]={exports:{}};t[s][0].call(c.exports,function(e){var r=t[s][1][e];return n(r?r:e)},c,c.exports,e,t,r,i)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)n(i[s]);return n}({1:[function(e,t){var r=e("./models/ErrorType"),i=function(){function e(){}return e.ERROR_ACCESS_DENIED="access_denied",e.ERROR_POPUP_OPEN={errorCode:r.popupOpen,message:"popup window is already open"},e.ERROR_WEB_REQUEST={errorCode:r.webRequestFailure,message:"web request failed, see console logs for details"},e.HTTP_GET="GET",e.HTTP_POST="POST",e.HTTP_PUT="PUT",e.LINKTYPE_WEB="webLink",e.LINKTYPE_DOWNLOAD="downloadLink",e.PARAM_ACCESS_TOKEN="access_token",e.PARAM_ERROR="error",e.PARAM_STATE="state",e.SDK_VERSION="js-v2.0",e.STATE_AAD_LOGIN="aad_tenant_login",e.STATE_AAD_PICKER="aad_picker",e.STATE_DISCOVERY="discovery",e.STATE_MSA_PICKER="msa_picker",e.TYPE_BOOLEAN="boolean",e.TYPE_FUNCTION="function",e.TYPE_OBJECT="object",e.TYPE_STRING="string",e.VROOM_URL="https://api.onedrive.com/v1.0/",e.VROOM_INT_URL="https://newapi.storage.live-int.com/v1.0/",e}();t.exports=i},{"./models/ErrorType":6}],2:[function(e,t){var r=e("./Constants"),i=e("./OneDriveApp"),n=function(){function e(){}return e.open=function(e){i.open(e)},e.save=function(e){i.save(e)},e.webLink=r.LINKTYPE_WEB,e.downloadLink=r.LINKTYPE_DOWNLOAD,e}();i.onloadInit(),t.exports=n},{"./Constants":1,"./OneDriveApp":3}],3:[function(e,t){var r=e("./utilities/DomUtilities"),i=e("./utilities/ErrorHandler"),n=e("./utilities/Logging"),o=e("./OneDriveState"),s=e("./utilities/Picker"),a=e("./models/PickerMode"),l=e("./utilities/RedirectUtilities"),c=e("./utilities/ResponseParser"),u=e("./utilities/Saver"),p=function(){function e(){}return e.onloadInit=function(){i.registerErrorObserver(o.clearState),r.getScriptInput(),n.logMessage("initialized");var e=l.handleRedirect();if(e){var t=c.parsePickerResponse(e),p=e.windowState.options,d=e.windowState.optionsMode;switch(d){case a[a.open]:var f=new s(p);t.error?f.handlePickerError(t):f.handlePickerSuccess(t);break;case a[a.save]:var h=new u(p);t.error?h.handleSaverError(t):h.handleSaverSuccess(t);break;default:i.throwError("invalid value for options.mode: "+d)}}},e.open=function(e){if(o.readyCheck()){e||i.throwError("missing picker options"),n.logMessage("open started");var t=new s(e);t.launchPicker()}},e.save=function(e){if(o.readyCheck()){e||i.throwError("missing saver options"),n.logMessage("save started");var t=new u(e);t.launchSaver()}},e}();t.exports=p},{"./OneDriveState":4,"./models/PickerMode":8,"./utilities/DomUtilities":14,"./utilities/ErrorHandler":15,"./utilities/Logging":17,"./utilities/Picker":19,"./utilities/RedirectUtilities":21,"./utilities/ResponseParser":22,"./utilities/Saver":23}],4:[function(e,t){var r=function(){function e(){}return e.clearState=function(){window.name="",e._isSdkReady=!0},e.readyCheck=function(){return e.clientIds&&e._isSdkReady?(e._isSdkReady=!1,!0):!1},e.getODCHost=function(){return(e.debug?"live-int":"live")+".com"},e.debug=!1,e._isSdkReady=!0,e}();t.exports=r},{}],5:[function(e,t){var r;!function(e){e[e.filesV2=0]="filesV2",e[e.other=1]="other",e[e.vroom=2]="vroom"}(r||(r={})),t.exports=r},{}],6:[function(e,t){var r;!function(e){e[e.badResponse=0]="badResponse",e[e.fileReaderFailure=1]="fileReaderFailure",e[e.popupOpen=2]="popupOpen",e[e.unknown=3]="unknown",e[e.unsupportedFeature=4]="unsupportedFeature",e[e.webRequestFailure=5]="webRequestFailure"}(r||(r={})),t.exports=r},{}],7:[function(e,t){var r=e("../utilities/CallbackInvoker"),i=e("../Constants"),n=e("../utilities/Logging"),o=e("../utilities/StringUtilities"),s=e("../utilities/TypeValidators"),a=function(){function e(e){this.openInNewWindow=s.validateType(e.openInNewWindow,i.TYPE_BOOLEAN,!0,!0),this.expectGlobalFunction=!this.openInNewWindow,this.expectGlobalFunction&&(this.cancelName=e.cancel,this.errorName=e.error);var t=s.validateCallback(e.cancel,!0,this.expectGlobalFunction);this.cancel=function(){n.logMessage("user cancelled operation"),r.invokeAppCallback(t,!0)};var a=s.validateCallback(e.error,!0,this.expectGlobalFunction);this.error=function(e){n.logError(o.format("error occured - code: '{0}', message: '{1}'",e.errorCode,e.message)),r.invokeAppCallback(a,!0,e)}}return e}();t.exports=a},{"../Constants":1,"../utilities/CallbackInvoker":13,"../utilities/Logging":17,"../utilities/StringUtilities":24,"../utilities/TypeValidators":25}],8:[function(e,t){var r;!function(e){e[e.open=0]="open",e[e.save=1]="save"}(r||(r={})),t.exports=r},{}],9:[function(e,t){var r=e("../utilities/CallbackInvoker"),i=e("../Constants"),n=e("./InvokerOptions"),o=e("../utilities/Logging"),s=e("./PickerMode"),a=e("../utilities/TypeValidators"),l=[i.LINKTYPE_DOWNLOAD,i.LINKTYPE_WEB],c=function(e){function t(t){e.call(this,t),this.expectGlobalFunction&&(this.successName=t.success);var n=a.validateCallback(t.success,!1,this.expectGlobalFunction);this.success=function(e){o.logMessage("picker operation succeeded"),r.invokeAppCallback(n,!0,e)},this.multiSelect=a.validateType(t.multiSelect,i.TYPE_BOOLEAN,!0,!1),this.linkType=a.validateType(t.linkType,i.TYPE_STRING,!0,i.LINKTYPE_DOWNLOAD,l),this.getWebLinks=this.linkType===i.LINKTYPE_WEB}return __extends(t,e),t.prototype.serializeState=function(){return{optionsMode:s[s.open],options:{success:this.successName,cancel:this.cancelName,error:this.errorName,linkType:this.linkType,multiSelect:this.multiSelect,openInNewWindow:this.openInNewWindow}}},t}(n);t.exports=c},{"../Constants":1,"../utilities/CallbackInvoker":13,"../utilities/Logging":17,"../utilities/TypeValidators":25,"./InvokerOptions":7,"./PickerMode":8}],10:[function(e,t){var r=e("../utilities/CallbackInvoker"),i=e("../Constants"),n=e("../utilities/DomUtilities"),o=e("../utilities/ErrorHandler"),s=e("./InvokerOptions"),a=e("../utilities/Logging"),l=e("./PickerMode"),c=e("../utilities/StringUtilities"),u=e("../utilities/TypeValidators"),p=e("./UploadType"),d=e("../utilities/UrlUtilities"),f=104857600,h="100 MB",g=function(e){function t(t){e.call(this,t),this.invalidFile=!1,this.expectGlobalFunction&&(this.successName=t.success,this.progressName=t.progress);var i=u.validateCallback(t.success,!1,this.expectGlobalFunction);this.success=function(){a.logMessage("saver operation succeeded"),r.invokeAppCallback(i,!0)};var n=u.validateCallback(t.progress,!0,this.expectGlobalFunction);this.progress=function(e){a.logMessage(c.format("upload progress: {0}%",e)),r.invokeAppCallback(n,!1,e)},this._setFileInfo(t)}return __extends(t,e),t.prototype.serializeState=function(){return{optionsMode:l[l.save],options:{success:this.successName,progress:this.progressName,cancel:this.cancelName,error:this.errorName,file:this.file,fileName:this.fileName,openInNewWindow:this.openInNewWindow}}},t.prototype._setFileInfo=function(e){this.file=u.validateType(e.file,i.TYPE_STRING);var t=u.validateType(e.fileName,i.TYPE_STRING,!0,null);if(d.isPathFullUrl(this.file))this.uploadType=p.url,this.fileName=t||d.getFileNameFromUrl(this.file),this.fileName||o.throwError("must supply a file name or a URL that ends with a file name");else if(d.isPathDataUrl(this.file))this.uploadType=p.dataUrl,this.fileName=t,this.fileName||o.throwError("must supply a file name for data URL uploads");else{this.uploadType=p.form;var r=n.getElementById(this.file);if(r instanceof HTMLInputElement){if("file"!==r.type&&o.throwError("input elemenet must be of type 'file'"),!r.value)return this.error({errorCode:0,message:"user has not supplied a file to upload"}),void(this.invalidFile=!0);var s=r.files;s&&window.FileReader||o.throwError("browser does not support Files API"),1!==s.length&&o.throwError("can not upload more than one file at a time");var a=s[0];if(a||o.throwError("missing file input"),a.size>f)return this.error({errorCode:1,message:"the user has selected a file larger than "+h}),void(this.invalidFile=!0);this.fileName=t||a.name,this.fileInput=a}else o.throwError("element was not an instance of an HTMLInputElement")}},t}(s);t.exports=g},{"../Constants":1,"../utilities/CallbackInvoker":13,"../utilities/DomUtilities":14,"../utilities/ErrorHandler":15,"../utilities/Logging":17,"../utilities/StringUtilities":24,"../utilities/TypeValidators":25,"../utilities/UrlUtilities":26,"./InvokerOptions":7,"./PickerMode":8,"./UploadType":11}],11:[function(e,t){var r;!function(e){e[e.dataUrl=0]="dataUrl",e[e.form=1]="form",e[e.url=2]="url"}(r||(r={})),t.exports=r},{}],12:[function(e,t){var r=e("./Logging"),i=e("./ObjectUtilities"),n=e("../OneDriveState"),o=e("./UrlUtilities"),s=function(){function e(){}return e.buildAccountChooserUrlForPicker=function(t){var r=i.serializeJSON(t.serializeState());return e._buildAccountChooserUrl("read",t.multiSelect?"multi":"single","file",r,t.linkType)},e.buildAccountChooserUrlForSaver=function(t){var r=i.serializeJSON(t.serializeState());return e._buildAccountChooserUrl("readwrite","single","folder",r)},e._buildAccountChooserUrl=function(e,t,i,s,a){var l={},c=n.clientIds.aadClientId;c&&(l.aad_client_id=c);var u=n.clientIds.msaClientId;u&&(l.msa_client_id=u),a&&(l.link_type=a),l.jssdk_state=s,l.ru=o.trimUrlQuery(window.location.href),l.access=e,l.selection_mode=t,l.view_type=i;var p=o.appendQueryStrings("https://onedrive."+n.getODCHost()+"/picker/accountchooser",l);return r.logMessage("invoking account chooser: "+p),p},e}();t.exports=s},{"../OneDriveState":4,"./Logging":17,"./ObjectUtilities":18,"./UrlUtilities":26}],13:[function(e,t){var r=e("../Constants"),i=e("../OneDriveState"),n=function(){function e(){}return e.invokeAppCallback=function(e,t){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];t&&i.clearState(),typeof e===r.TYPE_FUNCTION&&e.apply(null,n)},e.invokeCallbackAsynchronous=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];window.setTimeout(function(){e.apply(null,t)},0)},e}();t.exports=n},{"../Constants":1,"../OneDriveState":4}],14:[function(e,t){var r=e("./ErrorHandler"),i=e("./Logging"),n=e("../OneDriveState"),o=e("./StringUtilities"),s="client-id",a="debug",l="enable-logging",c="onedrive-js",u=new RegExp("^([a-fA-F0-9]){16}$"),p=new RegExp("^[a-fA-F\\d]{8}-([a-fA-F\\d]{4}-){3}[a-fA-F\\d]{12}$"),d=function(){function e(){}return e.getScriptInput=function(){var t=e.getElementById(c);if(t){var d=t.getAttribute(l);"true"===d&&(i.loggingEnabled=!0);var f=t.getAttribute(a);"true"===f&&(n.debug=!0);var h=t.getAttribute(s);h||r.throwError(o.format("SDK script tag missing '{0}' attribute",s));var g=h.split(",").map(function(e){return e.trim()});(g.length<1||g.length>2)&&r.throwError("expected 1 or 2 client ids");for(var v={},_=0;_<g.length;_++){var m=g[_];u.test(m)?(i.logMessage("parsed MSA client id: "+m),v.msaClientId=m):p.test(m)?(i.logMessage("parsed AAD client id: "+m),v.aadClientId=m):r.throwError(o.format("invalid format for client id '{0}' - MSA: 16 characters (HEX), AAD: 32 characters (HEX) GUID",m))}n.clientIds=v}else r.throwError(o.format("SDK script tag missing '{0}' id",c))},e.getElementById=function(e){return document.getElementById(e)},e.onDocumentReady=function(e){"interactive"===document.readyState||"complete"===document.readyState?e():document.addEventListener("DOMContentLoaded",e,!1)},e}();t.exports=d},{"../OneDriveState":4,"./ErrorHandler":15,"./Logging":17,"./StringUtilities":24}],15:[function(e,t){var r=e("./Logging"),i="[OneDriveSDK Error] ",n=function(){function e(){}return e.registerErrorObserver=function(t){e._errorObservers.push(t)},e.throwError=function(t){var n=e._errorObservers;for(var o in n)try{n[o]()}catch(s){r.logError("exception thrown invoking error observer",s)}throw new Error(i+t)},e._errorObservers=[],e}();t.exports=n},{"./Logging":17}],16:[function(e,t){var r=e("../Constants"),i=e("./Logging"),n=e("./ObjectUtilities"),o=e("../OneDriveState"),s=e("./StringUtilities"),a=e("./UrlUtilities"),l=e("./XHR"),c=10,u=function(){function e(){}return e.callFilesV2Open=function(e,t,u,p){var d=e.apiEndpointUrl,f=e.apiEndpoint,h=e.accessToken,g=o.clientIds.aadClientId,v=e.itemIds,_={};_.expand="thumbnails",_.select="id,content.downloadUrl,name,size";var m={};m.Authorization="bearer "+h,m["Cache-Control"]="no-cache, no-store, must-revalidate";var E,T=[],w=0,S=0,b=v.length,k=function(e,c){i.logMessage(s.format("running batch for items '{0}' - '{1}'",e+1,c+1));for(var u=e;c>u;u++){var p=v[u],h=a.appendToPath(d,"drive/items/"+p),S=new l({url:a.appendQueryStrings(h,_),clientId:g,method:r.HTTP_GET,apiEndpoint:f,headers:m});i.logMessage("performing GET on item with id: "+p),S.start(function(e,c,u){var p=n.deserializeJSON(e.responseText);if(t){var d=function(e,t,a){var c=new l({url:a,clientId:o.clientIds.aadClientId,method:r.HTTP_POST,apiEndpoint:f,headers:m,json:'{"type" : "view"}'});c.start(function(r){i.logMessage(s.format("POST createLink succeeded via path {0}",a));var o=n.deserializeJSON(r.responseText);t.webUrl=o.link.webUrl,e.push(t),E()},function(){i.logMessage(s.format("POST createLink failed via path {0}",a)),w++,E()})};d(T,p,a.trimUrlQuery(u)+"/action.createLink")}else T.push(p),E()},function(){w++,E()})}};E=function(){++S===b?(T.length&&(i.logMessage(s.format("GET metadata succeeded for '{0}' items",T.length)),u(T)),w&&(i.logMessage(s.format("GET metadata failed for '{0}' items",w)),p(w))):S%c===0&&k(S,Math.min(b,S+c))},k(0,Math.min(b,c))},e}();t.exports=u},{"../Constants":1,"../OneDriveState":4,"./Logging":17,"./ObjectUtilities":18,"./StringUtilities":24,"./UrlUtilities":26,"./XHR":29}],17:[function(e,t){var r="onedrive_enable_logging",i="[OneDriveSDK] ",n=function(){function e(){}return e.logError=function(t){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];e._log(t,!0,r)},e.logMessage=function(t){e._log(t,!1)},e._log=function(t,n){for(var o=[],s=2;s<arguments.length;s++)o[s-2]=arguments[s];(n||e.loggingEnabled||window[r])&&console.log(i+t,o)},e.loggingEnabled=!1,e}();t.exports=n},{}],18:[function(e,t){var r=e("../Constants"),i=e("./Logging"),n=function(){function e(){}return e.shallowClone=function(e){if(typeof e!==r.TYPE_OBJECT||!e)return null;var t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},e.deserializeJSON=function(e){var t=null;try{t=JSON.parse(e)}catch(n){i.logError("deserialization error"+n)}return(typeof t!==r.TYPE_OBJECT||null===t)&&(t={}),t},e.serializeJSON=function(e){return JSON.stringify(e)},e}();t.exports=n},{"../Constants":1,"./Logging":17}],19:[function(e,t){var r=e("./AccountChooser"),i=e("../Constants"),n=e("./ErrorHandler"),o=e("../models/ErrorType"),s=e("./FilesV2Wrapper"),a=e("./Logging"),l=e("./ObjectUtilities"),c=e("./Popup"),u=e("../models/PickerOptions"),p=e("./RedirectUtilities"),d=e("./StringUtilities"),f=e("./VroomWrapper"),h=["large","medium","small"],g=function(){function e(e){var t=l.shallowClone(e);this._pickerOptions=new u(t)}return e.prototype.launchPicker=function(){var e=this,t=this._pickerOptions,n=r.buildAccountChooserUrlForPicker(t),o=t.serializeState();if(t.openInNewWindow){var s=new c(n,function(t){e.handlePickerSuccess(t)},function(t){e.handlePickerError(t)});s.openPopup()||t.error(i.ERROR_POPUP_OPEN)}else p.redirect(n,o)},e.prototype.handlePickerSuccess=function(e){var t=e.pickerType;switch(t){case i.STATE_MSA_PICKER:this._handleMSAOpenResponse(e);break;case i.STATE_AAD_PICKER:this._handleAADOpenResponse(e);break;default:n.throwError("invalid value for picker type: "+t)}},e.prototype.handlePickerError=function(e){e.error===i.ERROR_ACCESS_DENIED?this._pickerOptions.cancel():this._pickerOptions.error({errorCode:o.unknown,message:"something went wrong: "+e.error})},e.prototype._handleMSAOpenResponse=function(e){var t=this,r=this._pickerOptions;f.callVroomOpen(e,r.getWebLinks,function(e){t._handleSuccessResponse({webUrl:e.webUrl,files:r.getWebLinks?e.children&&e.children.length>0?e.children:[e]:e.value},!0)},function(){r.error(i.ERROR_WEB_REQUEST)})},e.prototype._handleAADOpenResponse=function(e){var t=this,r=this._pickerOptions;s.callFilesV2Open(e,r.getWebLinks,function(e){t._handleSuccessResponse({webUrl:null,files:e})},function(e){r.error({errorCode:o.webRequestFailure,message:d.format("'{0}' web request(s) failed, see console log for details",e)})})},e.prototype._handleSuccessResponse=function(e,t){var r=this._pickerOptions,i={link:r.getWebLinks?e.webUrl:null,values:[]},n=e.files;n&&n.length||r.error({errorCode:o.badResponse,message:"no files returned"}),a.logMessage(d.format("returning '{0}' files picked",n.length));for(var s=0;s<n.length;s++){var l=n[s],c=r.getWebLinks?l.webUrl:l["@content.downloadUrl"],u={fileName:l.name,link:c,linkType:r.linkType,size:l.size};if(t){var p=[],f=l.thumbnails&&l.thumbnails[0];if(f)for(var g=0;g<h.length;g++)p.push(f[h[g]].url);u.thumbnails=p}i.values.push(u)}r.success(i)},e}();t.exports=g},{"../Constants":1,"../models/ErrorType":6,"../models/PickerOptions":9,"./AccountChooser":12,"./ErrorHandler":15,"./FilesV2Wrapper":16,"./Logging":17,"./ObjectUtilities":18,"./Popup":20,"./RedirectUtilities":21,"./StringUtilities":24,"./VroomWrapper":27}],20:[function(e,t){var r=e("./CallbackInvoker"),i=e("../Constants"),n=e("./Logging"),o=e("./ResponseParser"),s=800,a=650,l=500,c=function(){function e(e,t,r){this._messageCallbackInvoked=!1,this._url=e,this._successCallback=t,this._failureCallback=r}return e.canReceiveMessage=function(e){return e.origin===window.location.origin},e._createPopupFeatures=function(){var e=window.screenX+Math.max(window.outerWidth-s,0)/2,t=window.screenY+Math.max(window.outerHeight-a,0)/2,r=["width="+s,"height="+a,"top="+t,"left="+e,"status=no","resizable=yes","toolbar=no","menubar=no","scrollbars=yes"];return r.join(",")},e.prototype.openPopup=function(){return e._currentPopup&&e._currentPopup._isPopupOpen()?!1:(window.onedriveReceiveMessage||(window.onedriveReceiveMessage=function(t){var i=e._currentPopup;if(i&&i._isPopupOpen()){e._currentPopup=null;var n=o.parsePickerResponse(t);i._messageCallbackInvoked=!0,void 0===n.error?r.invokeCallbackAsynchronous(i._successCallback,n):r.invokeCallbackAsynchronous(i._failureCallback,n)}}),this._popup=window.open(this._url,"_blank",e._createPopupFeatures()),this._popup.focus(),this._createPopupPinger(),e._currentPopup=this,!0)},e.prototype._createPopupPinger=function(){var t=this,r=window.setInterval(function(){t._isPopupOpen()?t._popup.postMessage("ping","*"):(window.clearInterval(r),e._currentPopup=null,t._messageCallbackInvoked||(n.logMessage("closed callback"),t._failureCallback({error:i.ERROR_ACCESS_DENIED})))},l)},e.prototype._isPopupOpen=function(){return null!==this._popup&&!this._popup.closed},e}();t.exports=c},{"../Constants":1,"./CallbackInvoker":13,"./Logging":17,"./ResponseParser":22}],21:[function(e,t){var r=e("../Constants"),i=e("./DomUtilities"),n=e("./ErrorHandler"),o=e("./Logging"),s=e("./ObjectUtilities"),a=e("../OneDriveState"),l=e("./StringUtilities"),c=e("./TypeValidators"),u=e("./UrlUtilities"),p=e("./WindowState"),d=e("./XHR"),f="https://login.microsoftonline.com/common/oauth2/authorize",h="https://onedrive.live.com/picker/businessurldiscovery",g=function(){function e(){}return e.redirect=function(e,t,r){void 0===t&&(t=null),void 0===r&&(r=null),t&&p.setWindowState(t,r),window.location.replace(e)},e.handleRedirect=function(){var t=u.readCurrentUrlParameters(),i=p.getWindowState(),s=t[r.PARAM_STATE]||i[r.PARAM_STATE];s||t[r.PARAM_ERROR]!==r.ERROR_ACCESS_DENIED?s===r.STATE_AAD_PICKER&&(t[r.PARAM_STATE]=r.STATE_AAD_PICKER):t[r.PARAM_STATE]=r.STATE_MSA_PICKER;var a=t[r.PARAM_STATE];if(!a)return null;o.logMessage("current state: "+a);var l=i.options;l||n.throwError("missing options from serialized state");var d=c.validateType(l.openInNewWindow,r.TYPE_BOOLEAN);switch(d&&e._displayOverlay(),a){case r.STATE_DISCOVERY:e._handleDiscoverRedirect(t,d);break;case r.STATE_AAD_LOGIN:e._handleAADTenantLoginRedirect(t,d);break;case r.STATE_MSA_PICKER:case r.STATE_AAD_PICKER:var f={windowState:i,queryParameters:t};if(o.logMessage("sending invoker response"),!d)return f;e._sendResponse(f);break;default:n.throwError("invalid value for redirect state: "+a)}return null},e._handleDiscoverRedirect=function(t,i){i||e._displayOverlay();var n=t[r.PARAM_ACCESS_TOKEN];n||e._handleError("missing access token",i);var o=new d({url:u.appendQueryString(h,r.PARAM_ACCESS_TOKEN,n),method:r.HTTP_GET});o.start(function(t){var n=s.deserializeJSON(t.responseText);(!n.value||n.value.length<2)&&e._handleError("invalid response from discovery service",i);var o=n.value[1];o||e._handleError("received discovery response missing tenant infromation",i);var l=o.serviceResourceId,c=o.serviceEndpointUri,p={client_id:a.clientIds.aadClientId,resource:l,response_type:"token",redirect_uri:u.trimUrlQuery(window.location.href),state:r.STATE_AAD_LOGIN},d={discovery:{tenantUrl:l,apiEndpoint:c}};e.redirect(u.appendQueryStrings(f,p),d)},function(t,r){e._handleError(l.format("discovery request failed, status code: '{0}', response text: '{1}'",d.statusCodeToString(r),t.responseText),i)})},e._handleAADTenantLoginRedirect=function(t,i){i||e._displayOverlay();var n=t[r.PARAM_ACCESS_TOKEN];n||e._handleError("missing api access token",i);var o={aadAccessToken:n,state:r.STATE_AAD_PICKER},s=p.getWindowState(),a=s.discovery.tenantUrl;if(a.indexOf("http://")!=0&&a.indexOf("https://")!=0&&a.indexOf("//")!=0){a=""}a||e._handleError("missing tenant url",i),e.redirect(u.appendToPath(a,"MySiteRedirect.aspx?MySiteRedirect=AllDocuments&OneDrivePicker=1"),o,s)},e._sendResponse=function(e){var t=window.opener;t.onedriveReceiveMessage?t.onedriveReceiveMessage(e):(o.logError("error in window's opener, pop up will close."),n.throwError("SDK message receiver is undefined.")),window.close()},e._handleError=function(t,i){var n={};if(n[r.PARAM_ERROR]=t,i)e._sendResponse({queryParameters:n});else{o.logMessage("error in picker flow, redirecting back to app"),n[r.PARAM_STATE]=r.STATE_AAD_PICKER;var s=u.trimUrlQuery(window.location.href);e.redirect(u.appendQueryStrings(s,n))}},e._displayOverlay=function(){var e=document.createElement("div"),t=["position: fixed","width: 100%","height: 100%","top: 0px","left: 0px","background-color: white","opacity: 1","z-index: 10000"];e.id="od-overlay",e.style.cssText=t.join(";");var r=document.createElement("img"),n=["position: absolute","top: calc(50% - 40px)","left: calc(50% - 40px)"];r.id="od-spinner",r.src="https://p.sfx.ms/common/spinner_grey_40_transparent.gif",r.style.cssText=n.join(";"),e.appendChild(r);var o=document.createElement("style");o.type="text/css",o.innerHTML="body { visibility: hidden !important; }",document.head.appendChild(o),i.onDocumentReady(function(){var t=document.body;null!==t?t.insertBefore(e,t.firstChild):document.createElement("body").appendChild(e),document.head.removeChild(o)})},e}();t.exports=g},{"../Constants":1,"../OneDriveState":4,"./DomUtilities":14,"./ErrorHandler":15,"./Logging":17,"./ObjectUtilities":18,"./StringUtilities":24,"./TypeValidators":25,"./UrlUtilities":26,"./WindowState":28,"./XHR":29}],22:[function(e,t){var r=e("../models/ApiEndpoint"),i=e("../Constants"),n=e("./ErrorHandler"),o=e("./Logging"),s=e("../OneDriveState"),a="0000000000000000",l=a.length,c=new RegExp("^\\w+\\.\\w+:\\w+[\\|\\w+]+:([\\w]+\\!\\d+)(?:\\!(.+))*$"),u=function(){function e(){}return e.parsePickerResponse=function(t){o.logMessage("parsing picker response");var s=t.windowState;s||n.throwError("missing windowState from picker response");var a=t.queryParameters;a||n.throwError("missing queryParameters from picker response");var l=a[i.PARAM_ERROR];if(l)return{error:l};var c=a[i.PARAM_STATE],u={pickerType:c};switch(c){case i.STATE_MSA_PICKER:u.apiEndpoint=r.vroom,e._parseMSAResponse(u,a);break;case i.STATE_AAD_PICKER:u.apiEndpoint=r.filesV2,e._parseAADResponse(u,a,s);break;default:n.throwError("invalid value for picker type: "+c)}return u.accessToken||n.throwError("missing access token"),u.apiEndpointUrl||n.throwError("missing API endpoint URL"),u},e._parseMSAResponse=function(t,r){t.accessToken=r[i.PARAM_ACCESS_TOKEN],t.apiEndpointUrl=s.debug?i.VROOM_INT_URL:i.VROOM_URL;var o=r.scope;o||n.throwError("missing 'scope' paramter from MSA picker response");for(var a,l=o.split(" "),u=0;u<l.length&&!a;u++)a=c.exec(l[u]);a||n.throwError("scope was not formatted correctly");var p=a[1].split("_"),d=p[1],f=d.indexOf("!"),h=d.substring(0,f),g=d.substring(f),v=e._leftPadCid(h),_=v+g;t.ownerCid=v,t.itemId=_,t.authKey=a[2]},e._parseAADResponse=function(e,t,r){e.accessToken=r.aadAccessToken,e.apiEndpointUrl=r.discovery&&r.discovery.apiEndpoint;var i=t["item-id"].split(",");i.length||n.throwError("missing item id(s)"),e.itemIds=i},e._leftPadCid=function(e){return e.length===l?e:a.substring(0,l-e.length)+e},e}();t.exports=u},{"../Constants":1,"../OneDriveState":4,"../models/ApiEndpoint":5,"./ErrorHandler":15,"./Logging":17}],23:[function(e,t){var r=e("./AccountChooser"),i=e("./CallbackInvoker"),n=e("../Constants"),o=e("./ErrorHandler"),s=e("../models/ErrorType"),a=e("./Logging"),l=e("./ObjectUtilities"),c=e("../OneDriveState"),u=e("./Popup"),p=e("./RedirectUtilities"),d=e("../models/SaverOptions"),f=e("./StringUtilities"),h=e("../models/UploadType"),g=e("./UrlUtilities"),v=e("./VroomWrapper"),_=e("./XHR"),m=1e3,E=5,T=function(){function e(e){var t=l.shallowClone(e);this._saverOptions=new d(t)}return e.prototype.launchSaver=function(){var e=this,t=this._saverOptions;if(!t.invalidFile){var i=r.buildAccountChooserUrlForSaver(t),o=t.serializeState();if(t.openInNewWindow){var s=new u(i,function(t){e.handleSaverSuccess(t)},function(t){e.handleSaverError(t)});s.openPopup()||t.error(n.ERROR_POPUP_OPEN)}else p.redirect(i,o)}},e.prototype.handleSaverSuccess=function(e){var t=this,r=e.pickerType;switch(r){case n.STATE_MSA_PICKER:v.callVroomSave(e,function(r){var i=r.value;i||o.throwError("empty API response");var n=i[0].id;n&&1===i.length||o.throwError("incorrect number of folders returned"),t._executeUpload(e,n)},function(){t._saverOptions.error(n.ERROR_WEB_REQUEST)});break;case n.STATE_AAD_PICKER:var i=e.itemIds;1!==i.length&&o.throwError("incorrect number of folders returned");var s=i[0];s||(s="root"),c.debug&&OneDriveDebug&&(OneDriveDebug.accessToken=e.accessToken),this._executeUpload(e,s);break;default:o.throwError("invalid value for picker type: "+r)}},e.prototype.handleSaverError=function(e){e.error===n.ERROR_ACCESS_DENIED?this._saverOptions.cancel():this._saverOptions.error({errorCode:s.unknown,message:"something went wrong: "+e.error})},e.prototype._executeUpload=function(e,t){var r=this._saverOptions.uploadType;a.logMessage(f.format("beginning '{0}' upload",h[r]));var i=e.accessToken;switch(r){case h.dataUrl:case h.url:this._executeUrlUpload(e,t,i,r);break;case h.form:this._executeFormUpload(e,t,i);break;default:o.throwError("invalid value for upload type: "+r)}},e.prototype._executeUrlUpload=function(e,t,r,i){var o=this,a=this._saverOptions;if(i===h.url&&e.pickerType===n.STATE_AAD_PICKER)return void a.error({errorCode:s.unsupportedFeature,message:"URL upload not supported for AAD"});var u=g.appendToPath(e.apiEndpointUrl,"drive/items/"+t+"/children"),p={};p.Prefer="respond-async",p.Authorization="bearer "+r;var d={"@content.sourceUrl":a.file,name:a.fileName,file:{}},f=new _({url:u,clientId:c.clientIds.msaClientId,method:n.HTTP_POST,headers:p,json:l.serializeJSON(d),apiEndpoint:e.apiEndpoint});f.start(function(e,t){if(i!==h.dataUrl||200!==t&&201!==t)if(i===h.url&&202===t){var u=e.getResponseHeader("Location");u||a.error({errorCode:s.badResponse,message:"missing 'Location' header on response"}),o._beginPolling(u,r)}else a.error(n.ERROR_WEB_REQUEST);else c.debug&&OneDriveDebug&&(OneDriveDebug.itemUrl=l.deserializeJSON(e.responseText)["@odata.id"]),a.success()},function(){a.error(n.ERROR_WEB_REQUEST)})},e.prototype._executeFormUpload=function(e,t,r){var i=this._saverOptions,l=i.fileInput,u=null;window.File&&l instanceof window.File?u=new FileReader:o.throwError("file reader not supported"),u.onerror=function(e){a.logError("failed to read or upload the file",e),i.error({errorCode:s.fileReaderFailure,message:"failed to read or upload the file, see console log for details"})},u.onload=function(o){var s=g.appendToPath(e.apiEndpointUrl,"drive/items/"+t+"/children/"+i.fileName+"/content"),a={};a["@name.conflictBehavior"]=e.pickerType===n.STATE_AAD_PICKER?"fail":"rename";var l={};l.Authorization="bearer "+r;var u=new _({url:g.appendQueryStrings(s,a),clientId:c.clientIds.msaClientId,headers:l,apiEndpoint:e.apiEndpoint}),p=o.target.result;u.upload(p,function(){i.success()},function(){i.error(n.ERROR_WEB_REQUEST)},function(e,t){i.progress(t.progressPercentage)})},u.readAsArrayBuffer(l)},e.prototype._beginPolling=function(e,t){a.logMessage("polling for URL upload completion");var r=m,o=E,s={url:g.appendQueryString(e,n.PARAM_ACCESS_TOKEN,t),method:n.HTTP_GET},c=this._saverOptions,u=function(){var e=new _(s);e.start(function(e,t){switch(t){case 202:var s=l.deserializeJSON(e.responseText);c.progress(s.percentageComplete),o--||(r*=2,o=E),i.invokeCallbackAsynchronous(u,r);break;case 200:c.progress(100),c.success();break;default:c.error(n.ERROR_WEB_REQUEST)}},function(){c.error(n.ERROR_WEB_REQUEST)})};i.invokeCallbackAsynchronous(u,r)},e}();t.exports=T},{"../Constants":1,"../OneDriveState":4,"../models/ErrorType":6,"../models/SaverOptions":10,"../models/UploadType":11,"./AccountChooser":12,"./CallbackInvoker":13,"./ErrorHandler":15,"./Logging":17,"./ObjectUtilities":18,"./Popup":20,"./RedirectUtilities":21,"./StringUtilities":24,"./UrlUtilities":26,"./VroomWrapper":27,"./XHR":29}],24:[function(e,t){var r=/[\{\}]/g,i=/\{\d+\}/g,n=function(){function e(){}return e.format=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var o=function(e){var i=t[e.replace(r,"")];return null===i&&(i=""),i};return e.replace(i,o)},e}();t.exports=n},{}],25:[function(e,t){var r=e("../Constants"),i=e("./ErrorHandler"),n=e("./Logging"),o=e("./ObjectUtilities"),s=e("./StringUtilities"),a=function(){function e(){}return e.validateType=function(t,r,a,l,c){if(void 0===a&&(a=!1),void 0===t){if(a)return void 0===l&&i.throwError("default value missing"),n.logMessage("applying default value: "+l),l;i.throwError("object was missing and not optional")}var u=typeof t;return u!==r&&i.throwError(s.format("expected object type: '{0}', actual object type: '{1}'",r,u)),e._isValidValue(t,c)||i.throwError(s.format("object does not match any valid values: '{0}'",o.serializeJSON(c))),t},e.validateCallback=function(e,t,n){if(void 0===t&&(t=!1),void 0===n&&(n=!1),void 0===e){if(t)return null;i.throwError("function was missing and not optional")}var o=typeof e;o!==r.TYPE_STRING&&o!==r.TYPE_FUNCTION&&i.throwError(s.format("expected function type: 'function | string', actual type: '{0}'",o));var a=null;if(o===r.TYPE_STRING){var l=window[e];typeof l===r.TYPE_FUNCTION?a=l:i.throwError(s.format("could not find a function with name '{0}' on the window object",e))}else n?i.throwError("expected a global function"):a=e;return a},e._isValidValue=function(e,t){if(!Array.isArray(t))return!0;for(var r in t)if(e===t[r])return!0;return!1},e}();t.exports=a},{"../Constants":1,"./ErrorHandler":15,"./Logging":17,"./ObjectUtilities":18,"./StringUtilities":24}],26:[function(e,t){var r=e("./StringUtilities"),i=function(){function e(){}return e.appendToPath=function(e,t){return e+("/"!==e.charAt(e.length-1)?"/":"")+t},e.appendQueryString=function(t,r,i){return e.appendQueryStrings(t,(n={},n[r]=i,n))
;var n},e.appendQueryStrings=function(e,t){if(!t||0===Object.keys(t).length)return e;-1===e.indexOf("?")?e+="?":"&"!==e.charAt(e.length-1)&&(e+="&");var i="";for(var n in t)i+=(i.length?"&":"")+r.format("{0}={1}",encodeURIComponent(n),encodeURIComponent(t[n]));return e+i},e.readCurrentUrlParameters=function(){return e.readUrlParameters(window.location.href)},e.readUrlParameters=function(t){var r={},i=t.indexOf("?")+1,n=t.indexOf("#")+1;if(i>0){var o=n>i?n-1:t.length;e._deserializeParameters(t.substring(i,o),r)}return n>0&&e._deserializeParameters(t.substring(n),r),r},e.trimUrlQuery=function(e){var t=["?","#"];for(var r in t){var i=e.indexOf(t[r]);i>0&&(e=e.substring(0,i))}return e},e.getFileNameFromUrl=function(t){var r=e.trimUrlQuery(t);return r.substr(r.lastIndexOf("/")+1)},e.isPathFullUrl=function(e){return 0===e.indexOf("https://")||0===e.indexOf("http://")},e.isPathDataUrl=function(e){return 0===e.indexOf("data:")},e._deserializeParameters=function(e,t){for(var r=e.split("&"),i=0;i<r.length;i++){var n=r[i].split("=");2===n.length&&(t[decodeURIComponent(n[0])]=decodeURIComponent(n[1]))}},e}();t.exports=i},{"./StringUtilities":24}],27:[function(e,t){var r=e("../Constants"),i=e("./ErrorHandler"),n=e("./Logging"),o=e("./ObjectUtilities"),s=e("../OneDriveState"),a=e("./UrlUtilities"),l=e("./XHR"),c=function(){function e(){}return e.callVroomOpen=function(t,r,i,n){e._callVroom(t,r,!1,i,n)},e.callVroomSave=function(t,r,i){e._callVroom(t,!1,!0,r,i)},e._callVroom=function(e,t,c,u,p){var d=e.apiEndpointUrl,f=e.apiEndpoint,h=e.accessToken,g=e.ownerCid,v=e.itemId,_=e.authKey;!_&&t&&i.throwError("missing auth key");var m;t?(d=a.appendToPath(d,"drives/"+g+"/items/"+v),m={authKey:_,expand:"thumbnails,children(select=id,webUrl,name,size;expand=thumbnails)",select:"id,webUrl,name,size"}):(d=a.appendToPath(d,"drive/items/"+v+"/children"),m={},m[r.PARAM_ACCESS_TOKEN]=h,c?m.select="id":(m.expand="thumbnails",m.select="id,@content.downloadUrl,name,size"));var E=new l({url:a.appendQueryStrings(d,m),clientId:s.clientIds.msaClientId,method:r.HTTP_GET,apiEndpoint:f});n.logMessage("performing GET on sharing bundle with id: "+v),E.start(function(e){u(o.deserializeJSON(e.responseText))},function(){p()})},e}();t.exports=c},{"../Constants":1,"../OneDriveState":4,"./ErrorHandler":15,"./Logging":17,"./ObjectUtilities":18,"./UrlUtilities":26,"./XHR":29}],28:[function(e,t){var r=e("./Logging"),i=e("./ObjectUtilities"),n=function(){function e(){}return e.getWindowState=function(){return i.deserializeJSON(window.name||"{}")},e.setWindowState=function(t,n){void 0===n&&(n=null),null===n&&(n=e.getWindowState());for(var o in t)n[o]=t[o];var s=i.serializeJSON(n);r.logMessage("window.name = "+s),window.name=s},e}();t.exports=n},{"./Logging":17,"./ObjectUtilities":18}],29:[function(e,t){var r=e("../models/ApiEndpoint"),i=e("../Constants"),n=e("./ErrorHandler"),o=e("./Logging"),s=e("./StringUtilities"),a=3e4,l=-1,c=-2,u=-3,p=function(){function e(e){this._url=e.url,this._json=e.json,this._headers=e.headers||{},this._method=e.method,this._clientId=e.clientId,this._apiEndpoint=e.apiEndpoint||r.other,n.registerErrorObserver(this._abortRequest)}return e.statusCodeToString=function(e){switch(e){case-1:return"EXCEPTION";case-2:return"TIMEOUT";case-3:return"REQUEST ABORTED";default:return e.toString()}},e.prototype.start=function(e,t){var r=this;try{this._successCallback=e,this._failureCallback=t,this._request=new XMLHttpRequest,this._request.ontimeout=this._onTimeout,this._request.onreadystatechange=function(){if(!r._completed&&4===r._request.readyState){r._completed=!0;var e=r._request.status;400>e&&e>0?r._callSuccessCallback(e):r._callFailureCallback(e)}},this._method||(this._method=this._json?i.HTTP_POST:i.HTTP_GET),this._request.open(this._method,this._url,!0),this._request.timeout=a,this._setHeaders(),o.logMessage("starting request to: "+this._url),this._request.send(this._json)}catch(n){this._callFailureCallback(l,n)}},e.prototype.upload=function(e,t,r,n){var s=this;try{this._successCallback=t,this._progressCallback=n,this._failureCallback=r,this._request=new XMLHttpRequest,this._request.ontimeout=this._onTimeout,this._method=i.HTTP_PUT,this._request.open(this._method,this._url,!0),this._setHeaders(),this._request.onload=function(e){s._completed=!0;var t=s._request.status;200===t||201===t?s._callSuccessCallback(t):s._callFailureCallback(t,e)},this._request.onerror=function(e){s._completed=!0,s._callFailureCallback(s._request.status,e)},this._request.upload.onprogress=function(e){if(e.lengthComputable){var t={bytesTransferred:e.loaded,totalBytes:e.total,progressPercentage:0===e.total?0:e.loaded/e.total*100};s._callProgressCallback(t)}},o.logMessage("starting upload to: "+this._url),this._request.send(e)}catch(a){this._callFailureCallback(l,a)}},e.prototype._callSuccessCallback=function(t){o.logMessage("calling xhr success callback, status: "+e.statusCodeToString(t)),this._successCallback(this._request,t,this._url)},e.prototype._callFailureCallback=function(t,r){o.logError("calling xhr failure callback, status: "+e.statusCodeToString(t),this._request,r),this._failureCallback(this._request,t,t===c)},e.prototype._callProgressCallback=function(e){o.logMessage("calling xhr upload progress callback"),this._progressCallback(this._request,e)},e.prototype._abortRequest=function(){if(!this._completed){if(this._completed=!0,this._request)try{this._request.abort()}catch(e){}this._callFailureCallback(u)}},e.prototype._onTimeout=function(){this._completed||(this._completed=!0,this._callFailureCallback(c))},e.prototype._setHeaders=function(){for(var e in this._headers)this._request.setRequestHeader(e,this._headers[e]);this._clientId&&this._apiEndpoint!==r.other&&this._request.setRequestHeader("Application","0x"+this._clientId);var t=s.format("{0}={1}","SDK-Version",i.SDK_VERSION);switch(this._apiEndpoint){case r.filesV2:this._request.setRequestHeader("X-ClientService-ClientTag",t);break;case r.vroom:this._request.setRequestHeader("X-RequestStats",t);break;case r.other:break;default:n.throwError("invalid API endpoint: "+this._apiEndpoint)}this._method===i.HTTP_POST&&this._request.setRequestHeader("Content-Type",this._json?"application/json":"text/plain")},e}();t.exports=p},{"../Constants":1,"../models/ApiEndpoint":5,"./ErrorHandler":15,"./Logging":17,"./StringUtilities":24}]},{},[2])(2)});